================================================================================
                    CAB BOOKING SYSTEM - DATABASE DOCUMENTATION
                            February 6, 2026
================================================================================

TABLE OF CONTENTS
=================
1. SYSTEM OVERVIEW
2. LOGIN CREDENTIALS (TEST ACCOUNTS)
3. DATABASE STRUCTURE
4. DETAILED TABLE INFORMATION
5. SAMPLE DATA STATISTICS

================================================================================
1. SYSTEM OVERVIEW
================================================================================

Database System: PostgreSQL 15
Host: localhost
Port: 5433 (mapped from container port 5432)
Total Databases: 8 application databases + 1 legacy database

Connection String Format:
postgresql://postgres:postgres@localhost:5433/{database_name}

================================================================================
2. LOGIN CREDENTIALS (TEST ACCOUNTS)
================================================================================

⚠️  DEFAULT PASSWORD FOR ALL ACCOUNTS: Password123

ADMIN ACCOUNTS:
---------------
Email: admin@cabsystem.com
Password: Password123
Role: ADMIN
ID: a3000001-0000-0000-0000-000000000001

CUSTOMER ACCOUNTS:
------------------
1. Email: customer1@example.com
   Password: Password123
   Name: John Doe
   ID: c1000001-0000-0000-0000-000000000001

2. Email: customer2@example.com
   Password: Password123
   Name: Jane Smith
   ID: c1000002-0000-0000-0000-000000000002

3. Email: nguyen.van.a@gmail.com
   Password: Password123
   Name: Nguyễn Văn A
   ID: c1000003-0000-0000-0000-000000000003

4. Email: tran.thi.b@gmail.com
   Password: Password123
   Name: Trần Thị B
   ID: c1000004-0000-0000-0000-000000000004

DRIVER ACCOUNTS:
----------------
1. Email: driver1@example.com
   Password: Password123
   Name: Mike Johnson
   Vehicle: Toyota Vios (51A-12345)
   Status: ONLINE
   ID: d2000001-0000-0000-0000-000000000001

2. Email: driver2@example.com
   Password: Password123
   Name: Sarah Williams
   Vehicle: Honda City (51B-67890)
   Status: ONLINE
   ID: d2000002-0000-0000-0000-000000000002

3. Email: le.van.c@gmail.com
   Password: Password123
   Name: Lê Văn C
   Vehicle: Hyundai Accent (51C-11111)
   Status: OFFLINE
   ID: d2000003-0000-0000-0000-000000000003

4. Email: pham.van.d@gmail.com
   Password: Password123
   Name: Phạm Văn D
   Vehicle: Toyota Camry (51D-22222)
   Status: BUSY
   ID: d2000004-0000-0000-0000-000000000004

================================================================================
3. DATABASE STRUCTURE
================================================================================

┌─────────────────┬──────────────────────────────────────────────────────┐
│ Database Name   │ Purpose                                              │
├─────────────────┼──────────────────────────────────────────────────────┤
│ auth_db         │ User authentication & authorization                  │
│ user_db         │ User profiles and management (CUSTOMER/DRIVER)       │
│ driver_db       │ Driver-specific data (vehicles, licenses, status)    │
│ ride_db         │ Ride requests, trips, and ride history               │
│ booking_db      │ Booking management and scheduling                    │
│ payment_db      │ Payment transactions and financial records           │
│ pricing_db      │ Pricing rules, fare calculation, surge pricing       │
│ cab_booking     │ Legacy database (may be empty or deprecated)         │
└─────────────────┴──────────────────────────────────────────────────────┘

================================================================================
4. DETAILED TABLE INFORMATION
================================================================================

┌──────────────────────────────────────────────────────────────────────────┐
│                          DATABASE: auth_db                               │
└──────────────────────────────────────────────────────────────────────────┘

TABLE: users
------------
Description: Stores all user accounts (customers, drivers, admins)
Primary Key: id (UUID)

Columns:
  - id                 UUID          Primary key
  - email              VARCHAR(255)  Unique, indexed
  - phone              VARCHAR(20)   Unique, nullable, indexed
  - password_hash      VARCHAR(255)  Bcrypt hash (cost factor: 10-12)
  - role               ENUM          CUSTOMER | DRIVER | ADMIN
  - status             ENUM          ACTIVE | INACTIVE | SUSPENDED
  - first_name         VARCHAR(100)  Nullable
  - last_name          VARCHAR(100)  Nullable
  - avatar             VARCHAR(500)  URL to profile picture, nullable
  - created_at         TIMESTAMP     Default: NOW()
  - updated_at         TIMESTAMP     Auto-updated

Current Data:
  - Total users: 9
  - Customers: 4 (all ACTIVE)
  - Drivers: 4 (all ACTIVE)
  - Admins: 1 (ACTIVE)


TABLE: refresh_tokens
----------------------
Description: Stores JWT refresh tokens for session management
Primary Key: id (UUID)

Columns:
  - id                 UUID          Primary key
  - token_id           VARCHAR(255)  Unique token identifier
  - user_id            UUID          Foreign key to users.id
  - device_info        TEXT          Device/browser information
  - ip_address         VARCHAR(45)   Client IP address
  - expires_at         TIMESTAMP     Token expiry time
  - revoked            BOOLEAN       Default: false
  - revoked_at         TIMESTAMP     Nullable
  - created_at         TIMESTAMP     Default: NOW()

Indexes:
  - user_id (for fast lookup by user)
  - expires_at, revoked (for cleanup queries)


┌──────────────────────────────────────────────────────────────────────────┐
│                         DATABASE: driver_db                              │
└──────────────────────────────────────────────────────────────────────────┘

TABLE: drivers
--------------
Description: Driver profiles with vehicle and license information
Primary Key: id (UUID, matches user_id from auth_db)

Columns:
  - id                      UUID          Primary key (same as user.id)
  - user_id                 UUID          References users.id in auth_db
  - status                  ENUM          PENDING | APPROVED | REJECTED | SUSPENDED
  - availability_status     ENUM          OFFLINE | ONLINE | BUSY
  - vehicle_type            VARCHAR(50)   CAR | BIKE | VAN | etc.
  - vehicle_brand           VARCHAR(100)  e.g., Toyota, Honda
  - vehicle_model           VARCHAR(100)  e.g., Vios, City
  - vehicle_plate           VARCHAR(20)   License plate number
  - vehicle_color           VARCHAR(50)   Vehicle color
  - vehicle_year            INTEGER       Manufacturing year
  - license_number          VARCHAR(50)   Driver's license number
  - license_expiry_date     DATE          License expiration
  - license_verified        BOOLEAN       Default: false
  - rating_average          DECIMAL(3,2)  Average rating (0.00 - 5.00)
  - rating_count            INTEGER       Total number of ratings
  - current_ride_id         UUID          Current active ride, nullable
  - last_location_lat       DECIMAL(10,8) Last known latitude
  - last_location_lng       DECIMAL(11,8) Last known longitude
  - last_location_time      TIMESTAMP     Last location update time
  - created_at              TIMESTAMP     Default: NOW()
  - updated_at              TIMESTAMP     Auto-updated

Current Data:
  - Total drivers: 4
  - APPROVED + ONLINE: 2 drivers
  - APPROVED + OFFLINE: 1 driver
  - APPROVED + BUSY: 1 driver

Sample Driver:
  ID: d2000001-0000-0000-0000-000000000001
  Status: APPROVED, ONLINE
  Vehicle: Toyota Vios (White, 2022)
  Plate: 51A-12345
  License: DL12345678 (expires in 2+ years)
  Rating: 4.8/5.0 (245 reviews)
  Location: 10.7729°N, 106.6980°E (Ho Chi Minh City)


┌──────────────────────────────────────────────────────────────────────────┐
│                          DATABASE: ride_db                               │
└──────────────────────────────────────────────────────────────────────────┘

TABLE: rides
------------
Description: All ride requests and trips
Primary Key: id (UUID)

Columns:
  - id                    UUID          Primary key
  - customer_id           UUID          References users.id (CUSTOMER role)
  - driver_id             UUID          References drivers.id, nullable
  - status                ENUM          REQUESTED | ACCEPTED | IN_PROGRESS | 
                                        COMPLETED | CANCELLED
  - pickup_address        TEXT          Human-readable pickup address
  - pickup_lat            DECIMAL(10,8) Pickup latitude
  - pickup_lng            DECIMAL(11,8) Pickup longitude
  - dropoff_address       TEXT          Human-readable dropoff address
  - dropoff_lat           DECIMAL(10,8) Dropoff latitude
  - dropoff_lng           DECIMAL(11,8) Dropoff longitude
  - distance              DECIMAL(8,2)  Distance in kilometers
  - duration              INTEGER       Estimated duration in seconds
  - fare                  DECIMAL(10,2) Total fare in VND
  - surge_multiplier      DECIMAL(3,2)  Surge pricing multiplier (e.g., 1.5x)
  - payment_method        VARCHAR(50)   CASH | CARD | WALLET
  - cancelled_by          VARCHAR(20)   CUSTOMER | DRIVER | SYSTEM, nullable
  - cancellation_reason   TEXT          Nullable
  - requested_at          TIMESTAMP     Default: NOW()
  - accepted_at           TIMESTAMP     Nullable
  - started_at            TIMESTAMP     Nullable
  - completed_at          TIMESTAMP     Nullable
  - cancelled_at          TIMESTAMP     Nullable
  - created_at            TIMESTAMP     Default: NOW()
  - updated_at            TIMESTAMP     Auto-updated

Indexes:
  - customer_id
  - driver_id
  - status
  - requested_at

Note: Data availability depends on whether sample rides have been created.
      Initial seed file contains user/driver data but may not include rides.


┌──────────────────────────────────────────────────────────────────────────┐
│                        DATABASE: payment_db                              │
└──────────────────────────────────────────────────────────────────────────┘

TABLE: payments
---------------
Description: Payment transactions for rides
Primary Key: id (UUID)

Columns:
  - id                    UUID          Primary key
  - ride_id               UUID          References rides.id
  - customer_id           UUID          References users.id
  - driver_id             UUID          References drivers.id
  - amount                DECIMAL(10,2) Payment amount in VND
  - currency              VARCHAR(3)    Default: VND
  - payment_method        VARCHAR(50)   CASH | CARD | WALLET | MOMO | ZALOPAY
  - status                ENUM          PENDING | PROCESSING | COMPLETED | 
                                        FAILED | REFUNDED
  - transaction_id        VARCHAR(255)  External payment provider transaction ID
  - provider_response     JSONB         Payment gateway response data
  - paid_at               TIMESTAMP     Nullable
  - refunded_at           TIMESTAMP     Nullable
  - refund_amount         DECIMAL(10,2) Nullable
  - created_at            TIMESTAMP     Default: NOW()
  - updated_at            TIMESTAMP     Auto-updated

Indexes:
  - ride_id (unique)
  - customer_id
  - driver_id
  - status


┌──────────────────────────────────────────────────────────────────────────┐
│                        DATABASE: booking_db                              │
└──────────────────────────────────────────────────────────────────────────┘

TABLE: bookings
---------------
Description: Scheduled/advance bookings (future rides)
Primary Key: id (UUID)

Columns:
  - id                    UUID          Primary key
  - customer_id           UUID          References users.id
  - pickup_address        TEXT          Pickup location
  - pickup_lat            DECIMAL(10,8)
  - pickup_lng            DECIMAL(11,8)
  - dropoff_address       TEXT          Destination
  - dropoff_lat           DECIMAL(10,8)
  - dropoff_lng           DECIMAL(11,8)
  - scheduled_time        TIMESTAMP     When ride should start
  - vehicle_type          VARCHAR(50)   Preferred vehicle type
  - estimated_fare        DECIMAL(10,2) Estimated cost
  - status                ENUM          PENDING | CONFIRMED | ASSIGNED | 
                                        CONVERTED_TO_RIDE | CANCELLED
  - ride_id               UUID          Links to rides.id when converted
  - notes                 TEXT          Customer notes/preferences
  - created_at            TIMESTAMP     Default: NOW()
  - updated_at            TIMESTAMP     Auto-updated

Indexes:
  - customer_id
  - scheduled_time
  - status


┌──────────────────────────────────────────────────────────────────────────┐
│                        DATABASE: pricing_db                              │
└──────────────────────────────────────────────────────────────────────────┘

TABLE: pricing_rules
--------------------
Description: Dynamic pricing configuration
Primary Key: id (UUID)

Columns:
  - id                    UUID          Primary key
  - vehicle_type          VARCHAR(50)   CAR | BIKE | VAN
  - base_fare             DECIMAL(8,2)  Base fare in VND
  - per_km_rate           DECIMAL(8,2)  Rate per kilometer
  - per_minute_rate       DECIMAL(8,2)  Rate per minute
  - minimum_fare          DECIMAL(8,2)  Minimum charge
  - surge_multiplier      DECIMAL(3,2)  Current surge multiplier
  - active                BOOLEAN       Whether rule is active
  - effective_from        TIMESTAMP     Rule validity start
  - effective_until       TIMESTAMP     Rule validity end, nullable
  - created_at            TIMESTAMP     Default: NOW()
  - updated_at            TIMESTAMP     Auto-updated

Example for CAR:
  Base fare: 10,000 VND
  Per km: 12,000 VND
  Per minute: 2,000 VND
  Minimum fare: 20,000 VND


TABLE: surge_pricing
---------------------
Description: Real-time surge pricing by area
Primary Key: id (UUID)

Columns:
  - id                    UUID          Primary key
  - area_name             VARCHAR(100)  Geographic area identifier
  - lat_min               DECIMAL(10,8) Bounding box minimum latitude
  - lat_max               DECIMAL(10,8) Bounding box maximum latitude
  - lng_min               DECIMAL(11,8) Bounding box minimum longitude
  - lng_max               DECIMAL(11,8) Bounding box maximum longitude
  - multiplier            DECIMAL(3,2)  Surge multiplier (e.g., 1.5 = 50% increase)
  - reason                TEXT          Why surge is active
  - active_from           TIMESTAMP     Surge start time
  - active_until          TIMESTAMP     Surge end time, nullable
  - created_at            TIMESTAMP     Default: NOW()
  - updated_at            TIMESTAMP     Auto-updated


┌──────────────────────────────────────────────────────────────────────────┐
│                         DATABASE: user_db                                │
└──────────────────────────────────────────────────────────────────────────┘

TABLE: customer_profiles (if exists)
------------------------------------
Description: Extended customer information
Note: May be empty if all customer data is embedded in auth_db.users

TABLE: addresses (if exists)
----------------------------
Description: Saved addresses for customers (home, work, favorites)


┌──────────────────────────────────────────────────────────────────────────┐
│                      DATABASE: cab_booking (LEGACY)                      │
└──────────────────────────────────────────────────────────────────────────┘

Status: May be empty or deprecated - check if tables exist
Purpose: Possibly used in earlier monolithic version before microservices


================================================================================
5. SAMPLE DATA STATISTICS
================================================================================

TOTAL USERS BY ROLE:
--------------------
  ✓ Customers: 4 accounts (all ACTIVE)
  ✓ Drivers: 4 accounts (all ACTIVE)
  ✓ Admins: 1 account (ACTIVE)

DRIVERS BY STATUS:
------------------
  ✓ Online & Available: 2 drivers
  ✓ Offline: 1 driver
  ✓ Busy (on active ride): 1 driver
  ✓ All are APPROVED (can accept rides)

DRIVER RATINGS:
---------------
  • Highest rated: Sarah Williams (4.9/5.0, 312 reviews)
  • Mike Johnson: 4.8/5.0 (245 reviews)
  • Lê Văn C: 4.7/5.0 (189 reviews)
  • Phạm Văn D: 4.6/5.0 (156 reviews)

VEHICLES IN FLEET:
------------------
  • 4 Cars (Toyota x2, Honda x1, Hyundai x1)
  • Model years: 2021-2024
  • All vehicles have valid licenses (2+ year expiry)


================================================================================
6. TROUBLESHOOTING & COMMON ISSUES
================================================================================

❌ LOGIN FAILS WITH "INVALID CREDENTIALS"
-----------------------------------------
Solution:
1. Ensure you're using the correct password: "Password123" (case-sensitive)
2. Ensure email is lowercase (system converts to lowercase)
3. Check user status is ACTIVE:
   docker exec -it cab-postgres psql -U postgres -d auth_db -c \
     "SELECT email, role, status FROM users WHERE email='your@email.com';"
4. Clear browser localStorage/cookies if refresh tokens are stuck
5. Check auth service logs:
   docker logs cab-auth-service --tail 20


❌ "REFRESH TOKEN EXPIRED OR REVOKED" ERROR
-------------------------------------------
Solution:
1. Clear localStorage in browser developer tools:
   - localStorage.removeItem('accessToken');
   - localStorage.removeItem('refreshToken');
   - localStorage.removeItem('user');
2. Log out and log back in with fresh credentials


❌ API GATEWAY "FAILED TO CONNECT TO RABBITMQ"
----------------------------------------------
Impact: Non-critical - events won't be published but core functionality works
Solution:
1. Check RabbitMQ is running:
   docker ps | findstr rabbitmq
2. Restart API Gateway:
   docker restart cab-api-gateway


❌ EMPTY DATABASE / NO USERS FOUND
----------------------------------
Solution:
1. Run seed script to populate sample data:
   docker exec -i cab-postgres psql -U postgres < scripts/seed-sample-data.sql
2. Or manually copy and execute SQL from scripts/seed-sample-data.sql


================================================================================
7. DATABASE MANAGEMENT COMMANDS
================================================================================

CONNECT TO SPECIFIC DATABASE:
docker exec -it cab-postgres psql -U postgres -d {database_name}

EXPORT DATABASE:
docker exec cab-postgres pg_dump -U postgres {database_name} > backup.sql

IMPORT DATABASE:
docker exec -i cab-postgres psql -U postgres -d {database_name} < backup.sql

VIEW ALL TABLES IN DATABASE:
docker exec -it cab-postgres psql -U postgres -d {database_name} -c "\dt"

COUNT RECORDS IN TABLE:
docker exec -it cab-postgres psql -U postgres -d {database_name} -c \
  "SELECT COUNT(*) FROM {table_name};"

CLEAR ALL DATA (DANGEROUS):
docker exec -it cab-postgres psql -U postgres -c \
  "DROP DATABASE IF EXISTS auth_db; CREATE DATABASE auth_db;"
  
RESET AND RESEED:
cd scripts
./clear-db.bat (or clear-db.sh on Linux/Mac)
docker exec -i cab-postgres psql -U postgres < seed-sample-data.sql


================================================================================
8. POSTGRESQL ACCESS DETAILS
================================================================================

Container Name: cab-postgres
Database User: postgres
Database Password: postgres
Internal Port: 5432
External Port: 5433
Encoding: UTF-8
Locale: en_US.utf8

Connection Examples:

NodeJS/Prisma:
DATABASE_URL="postgresql://postgres:postgres@localhost:5433/auth_db"

Python:
postgresql://postgres:postgres@localhost:5433/auth_db

psql Command Line:
psql -h localhost -p 5433 -U postgres -d auth_db

DBeaver/DataGrip/pgAdmin:
Host: localhost
Port: 5433
User: postgres
Password: postgres
Database: {your_choice}


================================================================================
9. SCHEMA UPDATE & MIGRATION
================================================================================

PRISMA MIGRATIONS:

For each microservice with Prisma:

1. Generate migration after schema changes:
   cd services/{service-name}
   npx prisma migrate dev --name {migration_name}

2. Apply migrations in production:
   npx prisma migrate deploy

3. Generate Prisma Client:
   npx prisma generate

4. Reset database (DEV ONLY - deletes all data):
   npx prisma migrate reset


SYNC SCHEMAS ACROSS ALL SERVICES:

Windows:
cd scripts
./sync-schemas.ps1

Linux/Mac:
cd scripts
./sync-schemas.sh


================================================================================
END OF DOCUMENTATION
================================================================================

For questions or issues, refer to:
- README.md (project root)
- HUONG_DAN_TEST_HE_THONG.md (Vietnamese testing guide)
- scripts/SAMPLE-DATA.md (sample data details)

Last Updated: February 6, 2026
Generated by: GitHub Copilot (Claude Sonnet 4.5)
