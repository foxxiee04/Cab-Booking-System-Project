generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH
  CARD
  WALLET
}

model Fare {
  id              String    @id @default(uuid())
  rideId          String    @unique
  
  baseFare        Float
  distanceFare    Float
  timeFare        Float
  surgeMultiplier Float     @default(1.0)
  totalFare       Float
  
  distanceKm      Float
  durationMinutes Int
  
  currency        String    @default("VND")
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  payment         Payment?
}

model Payment {
  id              String        @id @default(uuid())
  rideId          String        @unique
  customerId      String
  driverId        String?
  
  amount          Float
  currency        String        @default("VND")
  
  method          PaymentMethod @default(CASH)
  status          PaymentStatus @default(PENDING)
  
  // Transaction details
  transactionId   String?
  gatewayResponse String?
  
  // Timestamps
  initiatedAt     DateTime      @default(now())
  completedAt     DateTime?
  failedAt        DateTime?
  refundedAt      DateTime?
  
  failureReason   String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  fare            Fare          @relation(fields: [rideId], references: [rideId])
  
  @@index([customerId, createdAt(sort: Desc)])
  @@index([driverId, createdAt(sort: Desc)])
  @@index([status])
}

// Outbox pattern for reliable event publishing
model OutboxEvent {
  id            String    @id @default(uuid())
  eventType     String
  payload       String    // JSON string
  correlationId String
  
  createdAt     DateTime  @default(now())
  publishedAt   DateTime?
  
  @@index([publishedAt])
}
