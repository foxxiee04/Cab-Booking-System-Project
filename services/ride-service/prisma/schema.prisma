// Prisma schema for Ride Service
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RideStatus {
  CREATED
  FINDING_DRIVER
  ASSIGNED
  ACCEPTED
  PICKING_UP
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Ride {
  id            String      @id @default(uuid())
  customerId    String
  driverId      String?
  status        RideStatus  @default(CREATED)
  
  // Booking preferences
  vehicleType   String      @default("ECONOMY")    // ECONOMY, COMFORT, PREMIUM
  paymentMethod String      @default("CASH")       // CASH, CARD, WALLET
  
  // Pickup location
  pickupAddress String
  pickupLat     Float
  pickupLng     Float
  
  // Dropoff location
  dropoffAddress String
  dropoffLat     Float
  dropoffLng     Float
  
  // Ride details
  distance      Float?      // in kilometers
  duration      Int?        // in seconds
  fare          Float?
  surgeMultiplier Float     @default(1.0)
  
  // Suggested & assigned drivers
  suggestedDriverIds String[]  @default([])
  acceptedDriverId   String?
  
  // Timestamps
  requestedAt   DateTime    @default(now())
  pickupAt      DateTime?
  assignedAt    DateTime?
  acceptedAt    DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  cancelledAt   DateTime?
  
  // Cancel info
  cancelReason  String?
  cancelledBy   String?     // 'CUSTOMER' | 'DRIVER' | 'SYSTEM'
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  transitions   RideStateTransition[]
  
  @@index([customerId, createdAt(sort: Desc)])
  @@index([driverId, createdAt(sort: Desc)])
  @@index([status])
}

model RideStateTransition {
  id          String      @id @default(uuid())
  rideId      String
  ride        Ride        @relation(fields: [rideId], references: [id])
  
  fromStatus  RideStatus?
  toStatus    RideStatus
  actorId     String?     // userId who triggered
  actorType   String?     // 'CUSTOMER' | 'DRIVER' | 'SYSTEM'
  reason      String?
  
  occurredAt  DateTime    @default(now())
  
  @@index([rideId, occurredAt])
}
